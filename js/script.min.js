`use strict`;let field_own=[],field_opponent=[],shipsOwn=[],shipsOpponent=[],availableFields=[],memberPositions=[],pushCells=[],name1='',name2='',currentGamer=1,myDestroyedShips=0,opponentDestroyedShips=0,numberGame=0,number=10;startApp();function startApp(){changeLocation();addClick('.form .form__change',changeLocation);addClick('.form .form__start',startGame)}function changeLocation(){document.querySelectorAll('.game__own .field__cell').forEach(cell=>{cell.innerHTML='';cell.className='field__cell';});for(let i=0;i<number;i++){field_own[i]=[];for(let j=0;j<number;j++){field_own[i][j]=1}}let ships=[4,3,3,2,2,2,1,1,1,1];shipsOwn=[];for(let i=0;i<ships.length;i++){field_own=ranking(field_own,ships[i],1)}}function ranking(a,b,c){while(true){let cell=Math.floor(Math.random()*number*number),position=Math.floor(Math.random()*2),column=Math.trunc(cell/number),row=cell%number,rightPosition=true,tempShips=[];if(position===0){for(let i=0;i<b;i++){if(typeof(a[column][row+i])==="undefined"||a[column][row+i]===2||a[column][row+i]===3){rightPosition=false;break}}if(rightPosition===true){for(let i=0;i<b;i++){a[column][row+i]=3;tempShips.push(row+i,column)}a=createBorder(a,column,row,position,b);if(c===1){shipsOwn.push(tempShips);renderShip(cell,position,b)}else{shipsOpponent.push(tempShips)}break}}else{for(let i=0;i<b;i++){if(typeof(a[column+i])==="undefined"||a[column+i][row]===2||a[column+i][row]===3){rightPosition=false;break}}if(rightPosition===true){for(let i=0;i<b;i++){a[column+i][row]=3;tempShips.push(row,column+i)}a=createBorder(a,column,row,position,b);if(c===1){renderShip(cell,position,b);shipsOwn.push(tempShips)}if(c===2){shipsOpponent.push(tempShips)}break}}}return a}function renderShip(a,b,c){let fieldCell=document.querySelectorAll('.game__own .field__cell');let ship=document.createElement('div');let width=(b===0)?35*c+2:37;let height=(b===1)?35*c+2:37;ship.className='ship';ship.style.width=width+'px';ship.style.height=height+'px';fieldCell[a].append(ship)}function startGame(){message();name1=document.querySelector('.form__input_own').value;name2=document.querySelector('.form__input_opponent').value;if(!/^[A-zА-я0-9]{3,30}$/i.test(name1)){message('Ваше имя должно состоять из букв латинского или русского языка длиной от 3 до 30 символов');return}if(!/^[A-zА-я0-9]{3,30}$/i.test(name2)){message('Имя компьютера должно состоять из букв латинского или русского языка длиной от 3 до 30 символов');return}name1=name1[0].toUpperCase()+name1.slice(1);name2=name2[0].toUpperCase()+name2.slice(1);document.querySelector('.game .game__setting').classList.add('game__setting_none');createTitle(name1,name2);createFieldOpponent();addClick('.game__opponent .field__container',clickController);createShipsOpponent();if(numberGame%2===0){currentGamer=1;message('Вы начинаете игру')}else{currentGamer=2;message(name2+' начинает игру')}currentStep()}function createTitle(a,b){if(document.querySelector('.score div')){return}document.querySelector('.score').innerHTML=`<div class="score__own show_left"title="${name1}">${a}</div><div class="score__result"><span class="score__number">0</span><span>:</span><span class="score__number">0</span></div><div class="score__opponent show_right"title="${name2}">${b}</div>`}function createFieldOpponent(){let game__opponent=document.createElement('div'),field__word=document.createElement('div'),field__container=document.createElement('div'),field__numbers=document.createElement('div'),cell='';game__opponent.className='game__opponent show_right';field__word.className='words field__word';field__container.className='field__container';field__numbers.className='numbers field__numbers';let word=['А','Б','В','Г','Д','Е','Ж','З','И','К'];for(let i=0;i<10;i++){cell+=`<div class="words__cell">${word[i]}</div>`}field__word.innerHTML=cell;cell='';for(let i=0;i<100;i++){cell+=`<div class="field__cell"></div>`}field__container.innerHTML=cell;cell='';for(let i=0;i<10;i++){cell+=`<div class="numbers__cell">${i+1}</div>`}field__numbers.innerHTML=cell;game__opponent.innerHTML='<div class="field"></div>';game__opponent.querySelector('.field').append(field__word,field__container,field__numbers);document.querySelector('.game, .game__opponent').append(game__opponent)}function createShipsOpponent(){field_opponent=[];shipsOpponent=[];for(let i=0;i<number;i++){field_opponent[i]=[];for(let j=0;j<number;j++){field_opponent[i][j]=1}}for(let i=0;i<number*number;i++){availableFields[i]=i}let ships=[4,3,3,2,2,2,1,1,1,1];for(let i=0;i<ships.length;i++){field_opponent=ranking(field_opponent,ships[i],2)}}function currentStep(){if(currentGamer===-1){return}if(currentGamer===2){setTimeout(bot,1000)}}function message(a=''){document.querySelector('.message').innerText=a}function clickController(a){let cell=a.target;if(currentGamer!==1||!cell||!cell.classList.contains('field__cell')){return}let position=0;while(cell.previousSibling){cell=cell.previousSibling;if(cell.nodeType===1){position++}}if(pushCells.indexOf(position)===-1){pushCells.push(position);audioExplosion();checking(position)}}function checking(a){let y=Math.trunc(a/number),x=a%number;let fieldCell=document.querySelectorAll('.game__opponent .field__cell');if(field_opponent[y][x]===1||field_opponent[y][x]===2){fieldCell[a].innerHTML='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="muff" x="0px" y="0px" width="30" height="30" viewBox="0 0 30 30" xml:space="preserve"><g><circle cx="15" cy="15" r="15"/></g></svg>';currentGamer=2;message('Вы промазали. Ходит '+name2);currentStep();return}if(field_opponent[y][x]===3){field_opponent[y][x]=-3;for(let i=0;i<shipsOpponent.length;i++){for(let j=0;j<shipsOpponent[i].length-1;j+=2){if(shipsOpponent[i][j]===x&&shipsOpponent[i][j+1]===y){shipsOpponent[i][j]=x.toString();shipsOpponent[i][j+1]=y.toString();determineStateShip(shipsOpponent[i],x,y,1,fieldCell);return}}}}}function determineStateShip(a,b,c,e,d){let destroyShip=true,position=10*c+b;for(let i=0;i<a.length;i++){if(typeof(a[i])==='number'){destroyShip=false;break}}d[position].innerHTML+='<div class="pinpoint"></div>';if(destroyShip===true){renderChangeState(a,d,e);if(e===2){memberPositions=[];myDestroyedShips++;message(name2+' убил ваш корабль. Ходит '+name2)}else{opponentDestroyedShips++;message('Вы убили корабль. Ходит '+name1)}checkGameOver()}else{if(e===2){memberPositions.push({y:c,x:b});message(name2+' ранил ваш корабль. Ходит '+name2)}else{message('Вы ранили корабль. Ходит '+name1)}}}function renderChangeState(a,b,c){for(let index=0;index<a.length;index+=2){let x=Number(a[index]);let y=Number(a[index+1]);for(let i=-1;i<=1;i++){for(let j=-1;j<=1;j++){if(x+i>=0&&x+i<number&&y+j>=0&&y+j<number){let boderPosition=10*(y+j)+(x+i);if(c===1){if(pushCells.indexOf(boderPosition)===-1){pushCells.push(boderPosition)}if(field_opponent[y+j][x+i]!==-3){b[boderPosition].innerHTML+='<div class="forbidden"></div>'}else{b[boderPosition].classList.add('field__cell_border')}}else{deleteField(x+i,y+j);if(field_own[y+j][x+i]!==-3){b[boderPosition].innerHTML+='<div class="forbidden"></div>'}else{if(b[boderPosition].querySelector('.ship')){b[boderPosition].querySelector('.ship').remove()}b[boderPosition].classList.add('field__cell_border')}}}}}}}function bot(){if(currentGamer!==2){return}if(availableFields.length===0){return}let position=randomPosition(availableFields),cell=availableFields[position],y=Math.trunc(cell/number),x=cell%number;if(memberPositions.length){let possible=possibleSolution();let random=randomPosition(possible);x=possible[random][0];y=possible[random][1];cell=possible[random][1]*10+possible[random][0];position=availableFields.indexOf(cell)}availableFields.splice(position,1);audioExplosion();let fieldCell=document.querySelectorAll('.game__own .field__cell');if(field_own[y][x]===1||field_own[y][x]===2){fieldCell[cell].innerHTML='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="muff" x="0px" y="0px" width="30" height="30" viewBox="0 0 30 30" xml:space="preserve"><g><circle cx="15" cy="15" r="15"/></g></svg>';currentGamer=1;message(name2+' промазал(а). Ходит '+name1);return}if(field_own[y][x]===3){field_own[y][x]=-3;for(let i=0;i<shipsOwn.length;i++){for(let j=0;j<shipsOwn[i].length-1;j+=2){if(shipsOwn[i][j]===x&&shipsOwn[i][j+1]===y){shipsOwn[i][j]=x.toString();shipsOwn[i][j+1]=y.toString();determineStateShip(shipsOwn[i],x,y,2,fieldCell);currentStep();return}}}}}function possibleSolution(){let tempPosition=[];if(memberPositions.length>1){for(let i=memberPositions.length-1;i>=0;i--){x=memberPositions[i].x;y=memberPositions[i].y;if(memberPositions[0].x===memberPositions[1].x){if(validPosition(x,y+1)){tempPosition.push([x,y+1]);break}else if(validPosition(x,y-1)){tempPosition.push([x,y-1]);break}}else{if(validPosition(x+1,y)){tempPosition.push([x+1,y]);break}else if(validPosition(x-1,y)){tempPosition.push([x-1,y]);break}}}}else if(memberPositions.length===1){if(validPosition(memberPositions[0].x-1,memberPositions[0].y)){tempPosition.push([memberPositions[0].x-1,memberPositions[0].y])}if(validPosition(memberPositions[0].x+1,memberPositions[0].y)){tempPosition.push([memberPositions[0].x+1,memberPositions[0].y])}if(validPosition(memberPositions[0].x,memberPositions[0].y-1)){tempPosition.push([memberPositions[0].x,memberPositions[0].y-1])}if(validPosition(memberPositions[0].x,memberPositions[0].y+1)){tempPosition.push([memberPositions[0].x,memberPositions[0].y+1])}}return tempPosition}function validPosition(a,b){if(a>=0&&a<number&&b>=0&&b<number&&availableFields.indexOf(10*b+a)!==-1){return true}else{return false}}function checkGameOver(){if(opponentDestroyedShips===10||myDestroyedShips===10){numberGame++;currentGamer=-1;if(opponentDestroyedShips===10){let lastScore=document.querySelectorAll('.score__result .score__number')[0];lastScore.innerHTML=Number(lastScore.innerText)+1;message('Поздравляю! Вы выиграли')}else{let lastScore=document.querySelectorAll('.score__result .score__number')[1];lastScore.innerHTML=Number(lastScore.innerText)+1;message(name2+' выиграл(а). Вы проиграли')}createNav()}}function createNav(){let nav=document.createElement('div');nav.className='nav show_right';nav.innerHTML=`<button class="nav__continue"title="Сохранить результат и начать новую игру">Играть еще</button><button class="nav__replay"title="Сохранить текущую позицию кораблей и переиграть">Переграть</button><button class="nav__exit"title="Сбросить результат и выйти в меню">Выход</button>`;document.body.append(nav);addClick('.nav .nav__continue',continueGame);addClick('.nav .nav__replay',replayGame);addClick('.nav .nav__exit',exitGame);removeClick('.game__opponent .field__container',clickController)}function deleteNav(){removeClick('.nav .nav__continue',continueGame);removeClick('.nav .nav__replay',replayGame);removeClick('.nav .nav__exit',exitGame);document.querySelector('.nav').remove()}function continueGame(){defaultSetting();document.querySelector('.message').innerHTML='';document.querySelector('.game .game__opponent').remove();document.querySelector('.game__setting .form__data').style.display='none';document.querySelector('.game__setting').classList.remove('game__setting_none');changeLocation()}function replayGame(){defaultSetting();document.querySelectorAll('.game__own .field__cell').forEach(cell=>{cell.innerHTML='';cell.className='field__cell';});for(let i=0;i<number;i++){for(let j=0;j<number;j++){if(field_own[i][j]===-3){field_own[i][j]=3}}}for(let i=0;i<shipsOwn.length;i++){for(let j=0;j<shipsOwn[i].length;j++){shipsOwn[i][j]=Number(shipsOwn[i][j])}}for(let i=0;i<shipsOwn.length;i++){let cell=shipsOwn[i][1]*10+shipsOwn[i][0];if(shipsOwn[i].length>2){if(shipsOwn[i][0]===shipsOwn[i][2]){renderShip(cell,1,Math.trunc(shipsOwn[i].length/2))}else{renderShip(cell,0,Math.trunc(shipsOwn[i].length/2))}}else{renderShip(cell,0,1)}}for(let i=0;i<number*number;i++){availableFields[i]=i}document.querySelector('.game__opponent').remove();createFieldOpponent();createShipsOpponent();currentGamer=2;if(numberGame%2===0){currentGamer=1;message('Вы начинаете игру')}else{currentGamer=2;message(name2+' начинает игру')}addClick('.game__opponent .field__container',clickController);currentStep()}function exitGame(){defaultSetting();document.querySelector('.game .game__opponent').remove();document.querySelector('.score').innerHTML='';document.querySelector('.message').innerHTML='';document.querySelector('.game__setting .form__data').style.display='block';document.querySelector('.game__setting').classList.remove('game__setting_none');numberGame=0;changeLocation()}function defaultSetting(){memberPositions=[];pushCells=[];myDestroyedShips=0;opponentDestroyedShips=0;availableFields=[];deleteNav()}function addClick(a,b){document.querySelector(a).addEventListener('click',b)}function removeClick(a,b){if(document.querySelector('selector')){document.querySelector(a).removeEventListener('click',b)}}function randomPosition(a){return Math.floor(Math.random()*(a.length))}function deleteField(a,b){if(a>=0&&a<number&&b>=0&&b<number){if(availableFields.indexOf(b*10+a)!==-1){availableFields.splice(availableFields.indexOf(b*10+a),1)}}}function createBorder(a,b,c,e,d){for(let i=-1;i<2;i++){if(e===0){if(b+i>=0&&b+i<number&&c-1>=0){a[b+i][c-1]=2}if(b+i>=0&&b+i<number&&c+d<number){a[b+i][c+d]=2}}else{if(c+i>=0&&c+i<number&&b-1>=0){a[b-1][c+i]=2}if(c+i>=0&&c+i<number&&b+d<number){a[b+d][c+i]=2}}}for(let i=0;i<d;i++){if(e===0){if(b-1>=0){a[b-1][c+i]=2}if(b+1<number){a[b+1][c+i]=2}}else{if(c-1>=0){a[b+i][c-1]=2}if(c+1<number){a[b+i][c+1]=2}}}return a}function audioExplosion(){let audio=new Audio();audio.src='audio/explosion.mp3';audio.autoplay=true}
